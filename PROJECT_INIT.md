# New Obsidian Plugin Project Initialization

This document provides step-by-step instructions for creating a new Obsidian plugin project.

## Prerequisites

Before starting, you'll need to decide on the following information:

1. **Plugin ID** (e.g., `obsidian-foo`) - Used in manifest.json and as the directory name. Must be unique in the Obsidian plugin ecosystem.
2. **Plugin Name** (e.g., `Foo`) - The display name users will see
3. **Plugin Description** - A brief description of what your plugin does
4. **Plugin License** - For package.json (default: MIT)
5. **Author Name** - Your name as it should appear in the plugin
6. **Author URL** (optional) - Your website or profile URL
7. **Author Email** - For the package.json author field
8. **Local Obsidian Vault Path** - The path to your Obsidian vault for testing (e.g., `/Users/yourname/Documents/MyVault`)

## Step-by-Step Setup

### 1. Initialize Project Structure

```bash
mkdir -p src test scripts build
```

### 2. Create a minimal package.json

```json
{
  "name": "[PLUGIN_ID]",
  "version": "1.0.0",
  "description": "[PLUGIN_DESCRIPTION]",
  "main": "main.js",
  "author": "[AUTHOR_NAME] <[AUTHOR_EMAIL]>",
  "license": "[LICENSE]"
}
```

### 3. Install Dependencies

```bash
npm install --save-dev dotenv esbuild gts obsidian typescript builtin-modules
```

### 4. Initialize GTS

```bash
# Initialize Google TypeScript Style (creates tsconfig.json, .eslintrc.json, .prettierrc.js, and more)
npx gts init --yes

# Remove the unnecessary index.ts file created by gts
rm src/index.ts
```

### 5. Add and revise scripts in package.json

Edit package.json to include this block:

```json
{
  …
  "scripts": {
    "dev": "node esbuild.config.mjs",
    "build": "tsc -noEmit -skipLibCheck && node esbuild.config.mjs production",
    "lint": "NODE_OPTIONS=\"--no-deprecation\" gts lint && prettier --check \"*.{css,md}\" \"src/**/*.{css,md}\"",
    "clean": "gts clean",
    "compile": "tsc",
    "fix": "NODE_OPTIONS=\"--no-deprecation\" gts fix && prettier --write \"*.{css,md}\" \"src/**/*.{css,md}\"",
    "prepare": "npm run compile",
    "test": "node --test --experimental-test-module-mocks build/test/*.test.js build/test/**/*.test.js",
    "pretest": "npm run compile",
    "posttest": "npm run lint",
    "package": "npm run build && cd build && zip -r [PLUGIN_ID].zip main.js manifest.json styles.css",
    "deploy_local": "node scripts/deploy-local.mjs"
  },
  …
}
```

### 6. Customize Generated Configuration Files

The `npx gts init` command creates several configuration files. You'll need to customize some of them:

**Update `.eslintrc.json`** to allow importing 'obsidian':

```json
{
  …
  "rules": {
    "n/no-unpublished-import": ["error", {"allowModules": ["obsidian"]}]
  }
  …
}
```

**Update `tsconfig.json`** for Obsidian plugin development:

```json
{
  "extends": "./node_modules/gts/tsconfig-google.json",
  "compilerOptions": {
    "rootDir": ".",
    "outDir": "build",
    "lib": ["DOM", "ES2022"],
    "target": "ES2022",
    "moduleResolution": "node",
    "isolatedModules": true,
    "exactOptionalPropertyTypes": true,
    "noImplicitOverride": true,
    "noPropertyAccessFromIndexSignature": true,
    "noUncheckedIndexedAccess": true
  },
  "include": ["src/**/*.ts", "test/**/*.ts"]
}
```

### 7. Update EditorConfig

Note: GTS already created `.editorconfig`. Verify it contains:

```
root = true

[*]
indent_style = space
indent_size = 2
end_of_line = lf
charset = utf-8
insert_final_newline = true
```

### 8. Create Build Configuration

Create `esbuild.config.mjs` (this is a hand-written configuration file specific to your project):

```javascript
import esbuild from 'esbuild';
import process from 'process';
import builtins from 'builtin-modules';
import {copyFile, mkdir} from 'fs/promises';

const banner = `/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
if you want to view the source, please visit the github repository of this plugin
*/
`;

const prod = process.argv[2] === 'production';

const copyPlugin = {
  name: 'copy-files',
  setup(build) {
    build.onEnd(async () => {
      await mkdir('build', {recursive: true});
      await copyFile('src/manifest.json', 'build/manifest.json');
      await copyFile('src/styles.css', 'build/styles.css');
    });
  },
};

const context = await esbuild.context({
  banner: {
    js: banner,
  },
  entryPoints: ['src/main.ts'],
  bundle: true,
  external: ['obsidian', 'electron', ...builtins],
  format: 'cjs',
  target: 'es2018',
  logLevel: 'info',
  sourcemap: prod ? false : 'inline',
  treeShaking: true,
  outfile: 'build/main.js',
  minify: prod,
  plugins: [copyPlugin],
});

if (prod) {
  await context.rebuild();
  process.exit(0);
} else {
  await context.watch();
}
```

### 9. Create Local Deploy Script

Create `scripts/deploy-local.mjs`:

```javascript
#!/usr/bin/env node

import 'dotenv/config';
import {copyFileSync, mkdirSync} from 'fs';
import {join} from 'path';

const pluginDir = process.env.OBSIDIAN_PLUGIN_PATH;
if (!pluginDir) {
  console.error('Please set OBSIDIAN_PLUGIN_PATH in .env file');
  process.exit(1);
}
mkdirSync(pluginDir, {recursive: true});

['main.js', 'manifest.json', 'styles.css'].forEach(file => {
  const src = join('build', file);
  const dest = join(pluginDir, file);
  copyFileSync(src, dest);
});

console.log('Deployed to', pluginDir);
```

### 10. Create Plugin Source Files

Create `src/manifest.json`:

```json
{
  "id": "[PLUGIN_ID]",
  "name": "[PLUGIN_NAME]",
  "version": "1.0.0",
  "description": "[PLUGIN_DESCRIPTION]",
  "author": "[AUTHOR_NAME]",
  "authorUrl": "[AUTHOR_URL]",
  "isDesktopOnly": false
}
```

Create an empty file at `src/styles.css`

Create `src/main.ts`:

```typescript
import {Plugin} from 'obsidian';

export default class [PLUGIN_NAME]Plugin extends Plugin {
  override async onload() {
    console.log('Loading [PLUGIN_NAME]');
  }

  override onunload() {
    console.log('Unloading [PLUGIN_NAME]');
  }
}
```

### 11. Create Git Configuration

Create `.gitignore`:

```
# npm
node_modules

# Don't include the build directory in the repo.
build/

# Exclude macOS Finder View States
.DS_Store

# Environment variables
.env
```

### 12. Set Up Git Hooks

Create `.git/hooks/pre-commit`:

```bash
#!/bin/sh
npm run fix
```

Make it executable:

```bash
chmod +x .git/hooks/pre-commit
```

### 13. Set Up Local Development Environment

Create `.env` file:

```
OBSIDIAN_PLUGIN_PATH=[VAULT_PATH]/.obsidian/plugins/[PLUGIN_ID]
```

### 14. Create Basic Test

Create `test/main.test.ts`:

```typescript
import {test} from 'node:test';
import * as assert from 'node:assert';

void test('basic test infrastructure works', () => {
  // Basic test to verify test infrastructure works
  assert.equal(1 + 1, 2);
});
```

### 15. Create README.md

Compose a standard README.md based on what you can glean about the project.

## Verification Steps

After completing the setup:

1. **Test the build system:**

   ```bash
   npm run build
   ```

2. **Run tests:**

   ```bash
   npm test
   ```

3. **Check linting:**

   ```bash
   npm run fix
   npm run lint
   ```

4. **Test local deployment:**

   ```bash
   npm run deploy_local
   ```

5. **Create a package:**
   ```bash
   npm run package
   ```

## Notes

- Throughout this document, placeholders are marked with `[BRACKETS]` - replace these with your actual values
- The NODE_OPTIONS flag suppresses deprecation warnings from the gts dependency (see [gts PR #928](https://github.com/google/gts/pull/928))
